# פרק 7: ולידציה ובקרת התאמת יתר (Overfitting)

***

## פרולוג: שירת הסירנה של ה-Backtest

באודיסיאה של הומרוס, הגיבור אודיסאוס חייב להפליג על פני אי הסירנות, יצורים מיתולוגיים ששירתם הקסומה מפתה מלחים אל מותם על החוף הסלעי. כדי לשרוד, אודיסאוס מצווה על צוותו לאטום את אוזניהם בשעוות דבורים, והוא קושר את עצמו לתורן ספינתו, כדי שיוכל לשמוע את השיר אך לא להתפתות לנווט את ספינתו לעבר הסלעים. ה-backtest הוא הסירנה של המשקיע הכמותי. הוא שר שיר יפהפה ומפתה של יחסי שארפ גבוהים ועקומות הון חלקות. הוא מבטיח עולם של רווחים חסרי מאמץ ונטולי סיכון. והוא פיתה משקיעים רבים אל אבדונם על חופיו הסלעיים של השוק החי.

פרק זה עוסק כיצד להיות אודיסאוס. הוא עוסק כיצד להקשיב לשיר של ה-backtest מבלי להתפתות לו. הוא עוסק בתהליך הקריטי, ולעתים קרובות הכואב, של **ולידציה (validation)**. הוא עוסק בהתמודדות עם החטא הקטלני של הפיננסים הכמותיים: **התאמת יתר (overfitting)**. התאמת יתר היא הפרקטיקה של כוונון מודל לנתונים ההיסטוריים בצורה כה מושלמת עד שהוא מאבד את כוח החיזוי שלו. מודל שהותאם יתר על המידה לא למד את הסיגנל הבסיסי; הוא פשוט שינן את הרעש. פרק זה יספק לכם את המסגרת האינטלקטואלית ואת הכלים המעשיים להתנגד לשירת הסירנה, לבנות אסטרטגיות שאינן רק יפות ב-backtest, אלא גם חזקות, אמינות, והכי חשוב, כשירות להפלגה.

## הפילוסופיה של ולידציה: מאמת לחוסן (Robustness)

לפני שנצלול לכלים הטכניים של ולידציה, עלינו להתמודד תחילה עם בעיה פילוסופית עמוקה: **בעיית האינדוקציה**, שניסח באופן המפורסם ביותר הפילוסוף דיוויד יום. הבעיה היא זו: רק בגלל שמשהו קרה בעבר, לעולם לא נוכל להיות בטוחים מבחינה לוגית שהוא יקרה בעתיד. רק בגלל שהשמש זרחה כל יום במיליארד השנים האחרונות, איננו יכולים להוכיח שהיא תזרח מחר. כל המדע מבוסס על ההנחה שחוקי הטבע קבועים לאורך זמן, אך זוהי הנחה שלעולם לא ניתן להוכיח.

כך גם בפיננסים כמותיים. לעולם לא נוכל להיות בטוחים שאסטרטגיה שעבדה בעבר תעבוד בעתיד. שווקים פיננסיים אינם נשלטים על ידי חוקים פיזיקליים בלתי משתנים. הם מערכות מורכבות ומסתגלות המורכבות מבני אדם לומדים ורגשיים. הקשרים שאנו מגלים בנתונים אינם אמיתות נצחיות; הם דפוסים זמניים ותלויי-הקשר שעלולים להיעלם בכל רגע.

משמעות הדבר היא שמטרת הוולידציה אינה "להוכיח" שאסטרטגיה תעבוד. זהו סטנדרט בלתי אפשרי. המטרה, במקום זאת, היא להעריך את ה**חוסן (robustness)** של אסטרטגיה. אסטרטגיה חזקה היא כזו שסביר שתתפקד היטב במגוון רחב של תנאי שוק שונים. זוהי אסטרטגיה שאינה רגישה יתר על המידה להנחות או לפרמטרים הספציפיים שלה. זוהי אסטרטגיה שיש לה סיפור כלכלי או התנהגותי סביר. מטרת הוולידציה היא לבנות את הביטחון שלנו שהאסטרטגיה שלנו אינה רק תוצר שברירי ומותאם-יתר של הנתונים ההיסטוריים, אלא מנוע אלפא חזק ועמיד.

## החטא הקטלני: צלילה לעומק התאמת היתר (Overfitting)

התאמת יתר היא הסכנה הגדולה ביותר במחקר כמותי. כדי להבין זאת, דמיינו סטודנט שמתכונן למבחן בהיסטוריה. סטודנט טוב ינסה ללמוד את הנושאים, הסיבות וההשפעות הבסיסיות של האירועים ההיסטוריים. סטודנט גרוע פשוט ישנן את התשובות לשאלות מהמבחן של שנה שעברה. הסטודנט הגרוע עשוי לקבל ציון מושלם אם שאלות המבחן יהיו זהות לאלו של שנה שעברה, אך הוא ייכשל כישלון חרוץ אם השאלות יהיו שונות. הסטודנט הגרוע ביצע התאמת יתר לנתוני האימון.

**פשרת ההטיה-שונות (Bias-Variance Trade-off):**
בסטטיסטיקה, זה ידוע כ**פשרת ההטיה-שונות**. זהו אחד המושגים הבסיסיים ביותר בכל למידת המכונה.
*   **הטיה (Bias)** היא השגיאה הנובעת ממודל פשוט מדי. מודל בעל הטיה גבוהה (כמו רגרסיה ליניארית פשוטה) עלול להיכשל בלכידת הקשרים האמיתיים והמורכבים בנתונים. הוא מבצע "underfitting" לנתונים.
*   **שונות (Variance)** היא השגיאה הנובעת ממודל מורכב מדי. מודל בעל שונות גבוהה (כמו רשת נוירונים עמוקה עם מיליוני פרמטרים) הוא כל כך גמיש שהוא יכול להתאים לרעש האקראי בנתוני האימון, ולא רק לסיגנל הבסיסי. הוא מבצע "overfitting" לנתונים.

מטרתו של מודל טוב היא למצוא את נקודת האמצע המתוקה, להיות מורכב מספיק כדי ללכוד את הסיגנל, אך לא כל כך מורכב שהוא מתחיל להתאים לרעש. התאמת יתר היא התוצאה של בניית מודל עם הטיה נמוכה אך שונות גבוהה.

**מקורות להתאמת יתר בפיננסים כמותיים:**
*   **מורכבות המודל (Model Complexity):** שימוש במודל עם יותר מדי פרמטרים ביחס לכמות הנתונים הזמינה.
*   **ריגול נתונים (Data Snooping):** תהליך של ניסיון של מודלים, משתנים ופרמטרים רבים ושונים על אותו מאגר נתונים עד שנמצא אחד שנראה טוב במקרה.
*   **תלות במשטר (Regime Dependence):** בניית מודל המותאם יתר על המידה למשטר שוק מסוים (למשל, שוק שורי בתנודתיות נמוכה) ושייכשל כאשר המשטר ישתנה.

## ארגז הכלים של ה-Quant לוולידציה מחוץ-למדגם (Out-of-Sample)

כיצד נוכל לדעת אם המודל שלנו מותאם יתר על המידה? הדרך היחידה היא לבדוק אותו על נתונים שהוא לא ראה קודם. זהו העיקרון של **בדיקה מחוץ-למדגם**.

**תקן הזהב: ה-"Lockbox" או מבחן מחוץ-למדגם אמיתי:**
הדרך הכנה והאמינה ביותר לבדוק מודל היא להשתמש ב-"lockbox" (קופסת נעילה). התהליך פשוט:
1.  חלק את הנתונים ההיסטוריים שלך לשני חלקים: **סט אימון (training set)** ו**סט נעילה (lockbox set)** (למשל, 20% הנתונים העדכניים ביותר).
2.  שים את נתוני הנעילה בצד בקופסת נעילה מטאפורית ואל תסתכל עליהם.
3.  בצע את כל פיתוח המודל, הבדיקות והכוונון שלך על סט האימון.
4.  כאשר יש לך מודל "אלוף" יחיד וסופי, בדוק אותו פעם אחת, ורק פעם אחת, על נתוני הנעילה.

ביצועי המודל על נתוני הנעילה הם ההערכה הטובה ביותר שלך לפוטנציאל האמיתי שלו מחוץ-למדגם. האתגר המעשי של גישה זו הוא שהיא דורשת היסטוריה ארוכה של נתונים ומשמעת רבה. הפיתוי "להציץ" בנתוני הנעילה הוא עצום.

**סוס העבודה: ולידציה מתגלגלת (Walk-Forward Validation):**
גישה מעשית יותר עבור חוקרים רבים היא **ולידציה מתגלגלת**. זהו תהליך איטרטיבי המדמה באופן הדוק יותר כיצד אסטרטגיה הייתה נסחרת בפועל בזמן אמת:
1.  חלק את הנתונים שלך לסדרה של חלונות מתגלגלים.
2.  בחלון הראשון, בצע אופטימיזציה למודל שלך על תקופה של נתונים היסטוריים (סט ה"אימון") ולאחר מכן בדוק אותו על תקופה עוקבת של נתונים (סט ה"בדיקה").
3.  גלגל את החלון קדימה בתקופה אחת וחזור על התהליך, תוך אופטימיזציה מחדש של המודל שלך בכל פעם.
4.  חבר יחד את התוצאות של כל תקופות הבדיקה כדי ליצור backtest רציף אחד מחוץ-למדגם.

**הטכנולוגיה המתקדמת ביותר: אימות צולב K-Fold עם טיהור ואמברגו:**
עבור בעיות רבות של למידת מכונה פיננסית, נדרשת טכניקה מתוחכמת יותר. לנתונים פיננסיים יש שתי תכונות שהופכות טכניקות אימות צולב סטנדרטיות (כמו K-fold) לבעייתיות: הנתונים אינם בלתי תלויים ושווי-התפלגות (הם אוטוקורלטיביים), ולתוויות יש לעתים קרובות אופק ארוך (למשל, אנו מנסים לחזות את התשואה בחודש הבא). זה יכול להוביל ל**דליפת מידע (information leakage)**, שבה מידע מסט האימון דולף לסט הבדיקה.

הפתרון הוא **אימות צולב K-fold עם טיהור ואמברגו (purged and embargoed K-fold cross-validation)**, טכניקה שפותחה על ידי מומחה למידת המכונה מרקוס לופז דה פראדו:
1.  **טיהור (Purging):** לאחר אימון המודל על סט האימון, אנו "מטהרים" כל תצפית מסט האימון שהתווית שלה חופפת לסט הבדיקה. זה מונע מהמודל להתאמן על מידע שהוא עכשווי לתקופת הבדיקה.
2.  **אמברגו (Embargoing):** לאחר מכן אנו מוסיפים תקופת "אמברגו" בין סוף סט האימון לתחילת סט הבדיקה. זה מונע מהמודל להתאמן על מידע שקודם מיד לתקופת הבדיקה, מה שעלול גם להוביל לדליפת מידע.

## בעיית הבדיקות המרובות: יחס שארפ מנוכה (Deflated Sharpe Ratio)

אפילו עם תהליך ולידציה קפדני מחוץ-למדגם, אנו עדיין עומדים בפני בעיית **הבדיקות המרובות (multiple testing)**, או ריגול נתונים. אם תבדוק מספיק אסטרטגיות שונות, אתה חייב למצוא אחת שנראית טוב אך ורק במקרה. דמיינו חדר מלא קופים המקלידים על מקלדות. בהינתן מספיק זמן, אחד מהם יקליד בסופו של דבר את כל כתבי שייקספיר. אבל זה לא אומר שהקוף הוא גאון ספרותי.

אנו זקוקים לדרך להתאים את מדדי הביצועים שלנו כדי לקחת בחשבון את מספר הבדיקות שביצענו. **יחס שארפ המנוכה (Deflated Sharpe Ratio - DSR)**, שפותח על ידי ביילי ולופז דה פראדו, הוא כלי רב עוצמה לעשות זאת. ה-DSR מעריך מה היה יחס השארפ של האסטרטגיה שלנו אילו לא היינו עוסקים בריגול נתונים. הנוסחה מורכבת, אך האינטואיציה פשוטה. הוא לוקח את יחס השארפ הנצפה ו"מנכה" אותו בסכום שהוא פרופורציונלי למספר הבדיקות שביצענו ולשונות של יחס השארפ עצמו.

DSR שאינו מובהק סטטיסטית הוא סימן אזהרה חזק לכך שביצועי האסטרטגיה שלנו עשויים להיות תוצאה של מזל, לא של מיומנות.

## מעבר ליחס שארפ: מבט הוליסטי יותר על ביצועים

יחס שארפ הוא מדד שימושי, אך לא שלם, של ביצועים. אסטרטגיה עם יחס שארפ גבוה עשויה עדיין להיות בלתי קבילה אם היא נוטה להפסדים נדירים וקטסטרופליים. אנו צריכים לאמץ מבט הוליסטי יותר על ביצועים.

**חשיבות ניתוח ה-Drawdown:**
**Drawdown** הוא ירידה משיא לשפל בערך הפורטפוליו. ה-**maximum drawdown** הוא הירידה הגדולה ביותר כזו שאסטרטגיה חוותה. עבור משקיעים רבים, ה-maximum drawdown הוא מדד חשוב יותר מיחס השארפ. זהו מדד ל"כאב" של האסטרטגיה. אסטרטגיה עם maximum drawdown של 50% עשויה לא להיות שרידה, לא משנה כמה גבוה יחס השארפ שלה. מדדי drawdown שימושיים אחרים כוללים את **יחס קלמאר (Calmar ratio)** (תשואה שנתית חלקי maximum drawdown) ואת **מדד הכיב (Ulcer Index)** (מדד לעומק ומשך ה-drawdowns).

**חשיבות הוולידציה מבוססת-"סיפור":**
אסטרטגיה שיש לה backtest טוב אך אין לה אינטואיציה כלכלית או התנהגותית סבירה, סביר יותר שהיא תוצאה של התאמת יתר. סיפור טוב אינו תחליף לוולידציה כמותית קפדנית, אך הוא מהווה השלמה חיונית לה. לפני שאתה משקיע באסטרטגיה, אתה אמור להיות מסוגל לספר סיפור פשוט ומשכנע על הסיבה שהיא צריכה לעבוד. ולידציה מבוססת-סיפור זו היא דרך רבת עוצמה להתגונן מפני סכנות ריגול הנתונים.

## מסקנה: הספקן הצנוע

תהליך הוולידציה הוא תהליך של טיפוח תחושה עמוקה ומתמדת של ענווה וספקנות. הוא עוסק בהכרה בכך שהשוק הוא מערכת מורכבת ומסתגלת שנמצאת בהתפתחות מתמדת. הוא עוסק בהבנה שהמודלים שלנו הם, במקרה הטוב, קירובים גסים של המציאות. הוא עוסק בלהיות המבקר האכזרי ביותר של עצמנו.

הכלים והטכניקות שנדונו בפרק זה - ה-lockbox, הוולידציה המתגלגלת, יחס שארפ המנוכה, ניתוח drawdown - הם כלי הנשק שיש לנו במלחמה נגד התאמת יתר. הם הכלים המאפשרים לנו לעבור מאמונה נאיבית ביופיים של ה-backtests שלנו להערכה בוגרת, חזקה וכנה יותר של הפוטנציאל האמיתי של האסטרטגיה שלנו. המשקיע הכמותי המצליח אינו זה עם ה-backtest היפה ביותר; הוא זה עם תהליך הוולידציה הקפדני והכן ביותר.