# פרק 7 - ולידציה ובקרת התאמת יתר

***

## למה הפרק הזה חשוב

בשלב זה, תכננתם סיגנל, בניתם תיק השקעות, ויישמתם תהליך ניהול סיכונים. יש לכם בדיקה לאחור (backtest) שנראית נהדר. אבל האם אתם יכולים לסמוך עליה? פרק זה עוסק במענה על שאלה זו. הוא עוסק בתהליך הקריטי של **ולידציה (validation)** ובחטא הקרדינלי של המימון הכמותי: **התאמת יתר (overfitting)**.

התאמת יתר היא הפרקטיקה של כוונון מודל כך שיתאים לנתונים ההיסטוריים בצורה מושלמת עד כדי כך שהוא מאבד את כוח הניבוי שלו. מודל שהותאם יתר על המידה למד את הרעש בנתונים, לא את הסיגנל. הוא ייראה יפהפה בבדיקה לאחור שלכם, אבל הוא יתפרק בעולם האמיתי. כפי שנאמר, "כל הבדיקות לאחור יפות".

פרק זה יספק לכם סט של כלים רבי עוצמה לבחינת הלחץ של האסטרטגיה שלכם ולהערכת הפוטנציאל האמיתי שלה מחוץ למדגם (out-of-sample). המטרה היא לבנות אסטרטגיה שהיא לא רק יפה בבדיקה לאחור, אלא גם חזקה ואמינה בעיני המשקיעים שלכם, והכי חשוב, בעיניכם.

## רעיונות מרכזיים

- **ולידציה מתגלגלת (Walk-Forward Validation):** שיטת בדיקה לאחור מציאותית יותר מאשר בדיקה פשוטה בתוך המדגם. בוולידציה מתגלגלת, אתם מבצעים אופטימיזציה של המודל שלכם על תקופה של נתונים היסטוריים (סט ה"אימון") ואז בודקים אותו על תקופה עוקבת של נתונים (סט ה"בדיקה"). לאחר מכן אתם מגלגלים את החלון קדימה, ומבצעים אופטימיזציה מחדש של המודל שלכם בכל פעם. זה מדמה כיצד הייתם סוחרים בפועל באסטרטגיה בזמן אמת.

- **אימות צולב K-Fold מטוהר עם אמברגו:** טכניקה מתוחכמת לוולידציה של מודל על מערך נתונים יחיד וקבוע. היא כוללת חלוקת הנתונים ל-*K* "קפלים" (folds) ואז אימון איטרטיבי של המודל על *K-1* קפלים ובדיקתו על הקפל הנותר. שלבי ה"טיהור" וה"אמברגו" הם חיוניים עבור נתונים פיננסיים, מכיוון שהם מונעים דליפת מידע מסט האימון לסט הבדיקה, במיוחד כאשר לתוויות שלכם יש אופק ארוך.

- **קופסה נעולה (Lockbox):** המבחן האולטימטיבי לביצועים מחוץ למדגם של מודל. לאחר שפיתחתם את המודל שלכם, אתם "נועלים אותו" ולא נוגעים בו שוב. לאחר מכן אתם בודקים אותו על מערך נתונים חדש לחלוטין שמעולם לא הסתכלתם עליו לפני כן (נתוני ה"קופסה הנעולה"). זוהי הדרך הכנה והאמינה ביותר להעריך את הפוטנציאל של אסטרטגיה.

- **בקרת בדיקות מרובות:** אם תבדקו מספיק אסטרטגיות שונות, אתם חייבים למצוא אחת שנראית טובה רק במקרה. זוהי הבעיה של **בדיקות מרובות (multiple testing)** (הידועה גם בשם ריגול נתונים - data snooping). עלינו להתאים את מדדי הביצועים שלנו כדי לקחת בחשבון את מספר האסטרטגיות שבדקנו. **יחס שארפ מנוכה (Deflated Sharpe Ratio)** הוא כלי רב עוצמה לעשות זאת.

## מתמטיקה שתשתמשו בה

### יחס שארפ מנוכה (DSR)

ה-DSR הוא דרך להעריך מה היה יחס שארפ של האסטרטגיה שלכם אילו לא הייתם עוסקים בריגול נתונים. הנוסחה היא:

*DSR = SR̂ \* N( (SR̂ - E[SR<sub>max</sub>]) / σ[SR<sub>max</sub>] )*

כאשר:
- *SR̂* הוא יחס שארפ הנצפה של האסטרטגיה שלכם.
- *E[SR<sub>max</sub>]* הוא יחס שארפ המקסימלי הצפוי שהייתם מוצאים אילו הייתם בודקים *N* אסטרטגיות שונות תחת השערת האפס שיחס שארפ האמיתי הוא אפס.
- *σ[SR<sub>max</sub>]* היא סטיית התקן של יחס שארפ המקסימלי.
- *N(.)* היא פונקציית ההתפלגות המצטברת של ההתפלגות הנורמלית הסטנדרטית.

DSR שאינו מובהק סטטיסטית מצביע על כך שביצועי האסטרטגיה שלכם עשויים להיות תוצאה של מזל, לא של מיומנות.

### שונות של יחס שארפ

יחס שארפ הוא רק אומדן, ויש לו שגיאת תקן. ניתן להעריך את השונות של יחס שארפ כך:

*Var(SR) = (1 + SR<sup>2</sup>/2) / T*

כאשר *T* הוא מספר התצפיות. נוסחה זו מאפשרת לנו לבנות רווחי סמך סביב אומדני יחס שארפ שלנו.

### גודל אמברגו מול אופק תווית

באימות צולב K-Fold מטוהר, גודל ה"אמברגו" (תקופת הנתונים שאתם מוציאים בין סט האימון לסט הבדיקה) צריך להיות גדול לפחות כמו אופק התוויות שלכם. לדוגמה, אם אתם מנסים לחזות תשואות במהלך החודש הבא, האמברגו שלכם צריך להיות באורך של חודש אחד לפחות. זה מבטיח שאין חפיפה בין המידע המשמש לאימון המודל לבין המידע המשמש לבדיקתו.

## דוגמה נרטיבית: מודל האלוף שנכשל מחוץ למדגם

צוות של מדעני נתונים בקרן גידור מבלה שנה בפיתוח מודל למידת מכונה מורכב למסחר בשוק המניות. הם משתמשים בכל טריק בספר: רשתות עצביות עמוקות, הגברת גרדיאנט, ומגוון רחב של מקורות נתונים חלופיים. הם מריצים אלפי בדיקות לאחור, ומכווננים את ההיפר-פרמטרים של המודל עד שהם משיגים יחס שארפ מדהים בתוך המדגם של 3.5.

הם מציגים את "מודל האלוף" שלהם לוועדת ההשקעות של הפירמה. אבל ראש מחלקת הסיכונים, ותיק ממולח, סקפטי. הוא שואל שאלה פשוטה: "האם בדקתם אותו על נתונים שלא ראיתם?"

הצוות נאלץ להודות שהם השתמשו בכל הנתונים הזמינים שלהם כדי לפתח את המודל. ראש מחלקת הסיכונים מתעקש שהם ישימו את המודל ב"קופסה נעולה" למשך שנה ויבדקו אותו על נתונים חדשים וחיים.

שנה לאחר מכן, התוצאות מגיעות. יחס שארפ מחוץ למדגם של המודל הוא -0.5. זה היה כישלון מוחלט. הצוות התאים יתר על המידה את המודל לנתונים ההיסטוריים, ויצר יצירת אמנות יפהפייה אך חסרת תועלת.

הקופסה הנעולה הצילה את הפירמה מהקצאת הון לאסטרטגיה מפסידה. זה היה שיעור כואב אך יקר ערך בחשיבותה של ולידציה כנה מחוץ למדגם.

## תרגול מעשי: הערכה מחדש של הסיגנל הטוב ביותר שלכם

1.  **קחו את האסטרטגיה הטובה ביותר שלכם:** קחו את האסטרטגיה בעלת הביצועים הטובים ביותר שפיתחתם עד כה בספר זה.
2.  **בצעו ולידציה מתגלגלת:** העריכו מחדש את ביצועיה באמצעות שיטת ולידציה קפדנית יותר, כגון ולידציה מתגלגלת. הקפידו להעריך מחדש את כל פרמטרי המודל שלכם בכל שלב של ניתוח הוולידציה המתגלגלת.
3.  **היו כנים לגבי בדיקות מרובות:** היו כנים עם עצמכם. כמה כייוונתם את פרמטרי האסטרטגיה (למשל, חלון המבט לאחור, תדירות האיזון מחדש) לאחר שראיתם את תוצאות הבדיקה לאחור הראשוניות? בצעו הערכה מציאותית של מספר הבדיקות שביצעתם.
4.  **חשבו את ה-DSR:** חשבו את יחס שארפ המנוכה של האסטרטגיה שלכם, תוך שימוש במספר הבדיקות המרובות המוערך שלכם. האם ה-DSR עדיין מובהק סטטיסטית?
5.  **נתחו את התוצאות:** כיצד הביצועים המאומתים בצורה חזקה יותר משתווים לבדיקה לאחור המקורית שלכם? האם יחס שארפ עדיין מובהק סטטיסטית? מה זה אומר לכם על חוסנה של האסטרטגיה שלכם?

## בחן את עצמך

- מה ההבדל בין סט אימון, סט ולידציה וסט בדיקה?
- מהי מטרת ה"טיהור" באימות צולב K-Fold מטוהר?
- מדוע חשוב להחזיק "קופסה נעולה" של נתונים שלעולם לא מסתכלים עליהם?
- מהי דליפת היפר-פרמטרים, וכיצד ניתן להימנע ממנה?

## מלכודות נפוצות

- **דליפת היפר-פרמטרים:** זוהי צורה עדינה של הטיית צפייה לעתיד. היא מתרחשת כאשר אתם משתמשים בסט הבדיקה כדי לכוונן את ההיפר-פרמטרים של המודל שלכם (למשל, קצב הלמידה במודל למידת מכונה). יש לכוונן את ההיפר-פרמטרים רק על סט ולידציה נפרד.
- **בחירה על סמך ביצועים מחוץ למדגם:** אם אתם בודקים עשרה מודלים שונים על הנתונים מחוץ למדגם שלכם ובוחרים את הטוב ביותר, אתם מבצעים סוג של הטיית בדיקות מרובות. ביצועי המודל הנבחר צפויים להיות מוגזמים.
- **הצצה לקופסה הנעולה:** הפיתוי להציץ בנתוני הקופסה הנעולה שלכם הוא עצום. עליכם להתנגד לו. ברגע שהסתכלתם על הנתונים, זה כבר לא מבחן אמיתי מחוץ למדגם.
- **התעלמות מהסיפור:** אסטרטגיה שיש לה בדיקה לאחור טובה אך אין לה אינטואיציה כלכלית סבירה, סביר יותר שהיא תוצאה של התאמת יתר. תמיד שאלו את עצמכם: *למה* האסטרטגיה הזו צריכה לעבוד?

## נקודות עיקריות

-   כל הבדיקות לאחור, במידה מסוימת, מותאמות יתר על המידה.
-   ולידציה קפדנית חיונית להערכת הפוטנציאל האמיתי של אסטרטגיה.
-   ולידציה מתגלגלת ואימות צולב K-Fold מטוהר הם כלים רבי עוצמה לבדיקה מחוץ למדגם.
-   היו תמיד כנים עם עצמכם לגבי מספר הבדיקות המרובות שביצעתם.
-   אסטרטגיה עם סיפור טוב צפויה להיות חזקה יותר.
