# פרק 2 - היגיינת נתונים ויושרה מחקרית (Point-in-Time או כלום)

***

## למה הפרק הזה חשוב

זה עשוי להיות הפרק החשוב ביותר בספר כולו. יכול להיות לכם רעיון ההשקעה המבריק ביותר, המודל המתוחכם ביותר והמחשבים החזקים ביותר. אבל אם הנתונים שלכם פגומים, התוצאות שלכם יהיו חסרות ערך. זבל נכנס, זבל יוצא.

פרק זה עוסק בבניית מבצר סביב תהליך המחקר שלכם. הוא עוסק במניעת שתי השגיאות הבוגדניות והנפוצות ביותר במימון כמותי: **הטיית שרידות (survivorship bias)** ו**הטיית צפייה לעתיד (look-ahead bias)**. שגיאות אלו הן כמו רוחות רפאים במכונה; הן עדינות, קשות לאיתור, והן ירדפו את הבדיקות לאחור (backtests) שלכם, ויגרמו להן להיראות הרבה יותר טובות ממה שהיו במציאות.

לפני שאתם כותבים שורת קוד אחת עבור סיגנל מסחר, עליכם להפוך תחילה לבלשי נתונים. המנטרה שלכם חייבת להיות: **Point-in-Time או כלום.**

## רעיונות מרכזיים

- **נתוני Point-in-Time (PIT):** זהו כלל הזהב. מסד נתונים PIT הוא תמונת מצב מושלמת של העולם כפי שהיה ידוע *באותו רגע בדיוק בזמן*. הוא כולל את כל הנתונים שהיו זמינים, והוא אינו כולל את כל הנתונים שלא היו. לדוגמה, אם חברה מפרסמת מחדש את רווחיה, מסד נתונים PIT יציג את נתון הרווחים המקורי והשגוי עד לתאריך הפרסום מחדש, ובנקודה זו הוא יעודכן.

- **תיקונים ופרסומים מחדש:** חברות מתקנות לעתים קרובות את הדוחות הכספיים שלהן. מסד נתונים שאינו PIT יציג לעתים קרובות רק את המספר המעודכן והמתוקן, מה שגורם לזה להיראות כאילו הייתה לכם גישה למידע שלא היה ציבורי באמת באותה עת. זוהי צורה קלאסית של הטיית צפייה לעתיד.

- **פעולות תאגידיות:** אלו הם אירועים בעלי השפעה מהותית על מחיר המניה ומבנה המניות של החברה. הם כוללים:
    - **פיצולים (Splits):** פיצול מניות של 2 ל-1 מכפיל את מספר המניות ומחצית את המחיר. יש להתאים את נתוני המחירים שלכם כדי לקחת זאת בחשבון.
    - **דיבידנדים (Dividends):** כאשר חברה משלמת דיבידנד, מחיר המניה שלה יורד בדרך כלל בסכום המקביל. יש לחשב את התשואות שלכם על בסיס **תשואה כוללת (total return)**, הכוללת דיבידנדים.
    - **פיצולים (Spinoffs):** חברה עשויה לפצל חטיבה לחברה חדשה ועצמאית. בעלי המניות של חברת האם יקבלו מניות בחברה החדשה.
    - **מחיקות (Delistings):** חברות שפושטות רגל או נרכשות נמחקות מהבורסה. זהו המקור העיקרי ל**הטיית שרידות**. אם תכללו רק את ה"שורדים" בבדיקה לאחור שלכם, התוצאות שלכם יהיו מנופחות באופן מלאכותי.

- **חותמות זמן של אירועים:** ידיעת התאריך המדויק, ואם אפשר, השעה של אירוע היא קריטית. האם חברה פרסמה את דוח הרווחים שלה לפני פתיחת השוק או לאחר סגירתו? לתשובה יכולה להיות השפעה עצומה על האופן שבו אתם ממדלים את תגובת השוק.

- **לוחות שנה של בורסות ואזורי זמן:** ימי המסחר ושעות המסחר משתנים ברחבי העולם. חג ביפן עשוי להיות יום מסחר בלונדון. עליכם להחזיק בלוח שנה מדויק עבור כל בורסה שבה אתם סוחרים.

## מתמטיקה/נהלים

### שחזור תשואה כוללת

כדי לחשב במדויק תשואות היסטוריות, עליכם לשחזר סדרת תשואה כוללת מנתוני מחירים גולמיים ונתוני פעולות תאגידיות. הנוסחה לתשואה כוללת יומית היא:

*TR<sub>t</sub> = (P<sub>t</sub> + D<sub>t</sub> - S<sub>t</sub>) / P<sub>t-1</sub> - 1*

כאשר:
- *P<sub>t</sub>* הוא המחיר המתואם לפיצול בזמן *t*.
- *D<sub>t</sub>* הוא הדיבידנד למניה ששולם ביום *t*.
- *S<sub>t</sub>* הוא הערך של כל פיצול או חלוקה אחרת ביום *t*.

חיוני שנתוני הפעולות התאגידיות ייושמו בתאריך ה-ex-dividend הנכון.

### יישור זמן אירוע

כאשר חוקרים את ההשפעה של אירוע (כמו הכרזת רווחים), לעתים קרובות אנו רוצים ליישר מניות מרובות ב"זמן אירוע". יום 0 הוא יום ההכרזה. יום -1 הוא היום שלפני, ויום +1 הוא היום שאחרי. זה מאפשר לנו לצבור את התוצאות של אירועים רבים ושונים שהתרחשו בתאריכים קלנדריים שונים.

### Block Bootstrap מול IID Bootstrap

כאשר אנו בודקים את המובהקות הסטטיסטית של התוצאות שלנו, אנו משתמשים לעתים קרובות בטכניקה הנקראת bootstrapping, הכוללת דגימה מחדש של הנתונים שלנו עם החלפה. עם זאת, אם הנתונים הם בעלי אוטוקורלציה (כפי שקורה לעתים קרובות בסדרות זמן פיננסיות), ה-bootstrap הסטנדרטי של "בלתי תלויים ושווי התפלגות" (IID) אינו מתאים. ה-**block bootstrap** הוא טכניקה חזקה יותר הכוללת דגימה מחדש של בלוקים של נקודות נתונים עוקבות, ובכך משמרת את מבנה האוטוקורלציה. בחירת גודל הבלוק היא פרמטר קריטי בהליך זה.

## דוגמה נרטיבית: הבדיקה לאחור ש"ניצחה את השוק"

אנליסט צעיר ושאפתן בונה בדיקה לאחור של אסטרטגיית ערך פשוטה. הוא מוריד רשימה של כל המניות במדד S&P 500 *היום*, ואז מושך את הנתונים הפיננסיים ההיסטוריים שלהן ל-20 השנים האחרונות. הוא קונה את 10% המניות עם יחס המחיר לספר הנמוך ביותר ומאזן מחדש מדי שנה.

התוצאות מדהימות. האסטרטגיה מספקת תשואה שנתית של 25%, ומרסקת את השוק. האנליסט מוכתר כגאון.

אבל יש פגם קטלני. על ידי שימוש ברשימת חברות ה-S&P 500 מ*היום*, הוא ביצע הטיית שרידות. הוא לא כלל, מבלי משים, את כל החברות שהיו ב-S&P 500 בשלב כלשהו ב-20 השנים האחרונות אך מאז פשטו רגל או נרכשו. אלו הם, בהגדרה, המפסידים. הבדיקה לאחור שלו כללה רק את המנצחים, החברות שהצליחו מספיק כדי לשרוד 20 שנה.

חוקר זהיר יותר היה משתמש ברשימת חברי מדד point-in-time עבור כל שנה של הבדיקה לאחור. התוצאות של בדיקה לאחור מציאותית יותר זו היו מרשימות הרבה פחות.

## תרגול מעשי: שחזור מדד

זהו תרגיל מאתגר אך בעל ערך רב.

1.  **השגת חברים היסטוריים:** השיגו רשימה של החברים ההיסטוריים של מדד מניות מרכזי (כמו ה-S&P 500) לתקופה מסוימת (למשל, 5 השנים האחרונות). ניתן למצוא נתונים אלה בארכיונים היסטוריים או לרכוש אותם מספקי נתונים מיוחדים.
2.  **איסוף נתונים גולמיים:** מצאו מקור לנתוני מחירים יומיים גולמיים ולא מתואמים ונתוני פעולות תאגידיות עבור כל המניות הללו. ודאו שנתוני הפעולות התאגידיות שלכם כוללים תאריכי ex-date ותאריכי תשלום.
3.  **בניית המדד:** כתבו את הקוד ליצירת סדרת זמן יומית של התשואה הכוללת של המדד, כאילו הייתם מחשבים אותה בזמן אמת. תצטרכו לטפל בכל הפעולות התאגידיות ושינויי החברים במדד בצורה נכונה.
4.  **השוואה ויישוב:** השוו את המדד המשוחזר שלכם לתשואת המדד שפורסמה בפועל. האם אתם יכולים להתאים אותו בצורה מושלמת? אם לא, האם אתם יכולים להסביר את הפערים? תהליך יישוב זה הוא דרך רבת עוצמה לחשוף בעיות נתונים עדינות.
5.  **יצירת יומן ביקורת:** בנו "יומן ביקורת" העוקב אחר כל התאמה שאתם מבצעים בנתונים. זה יהיה כלי רב ערך לניפוי שגיאות ולהדגמת תקינות התהליך שלכם.

## בחן את עצמך

- מה ההבדל בין תשואת מחיר לתשואה כוללת?
- כיצד היית מטפל בפיצול מניות של 3 ל-2 בנתוני המחירים שלך?
- מה הסכנה בשימוש במסד נתונים שאינו מספק נתונים פיננסיים point-in-time?
- האם אתה יכול להפיק "דוח מקור" עבור הנתונים שלך, העוקב אחריהם עד למקורם המקורי?

## מלכודות נפוצות

- **ברירות מחדל של ספקים:** לעולם אל תסמכו על הגדרות ברירת המחדל של ספק נתונים. שאלו תמיד שאלות מפורטות על האופן שבו הם מטפלים בפעולות תאגידיות, פרסומים מחדש ובעיות נתונים אחרות.
- **אי התאמות בשעון קיץ:** בעיה עדינה אך אמיתית. המרות אזורי זמן חייבות לקחת בחשבון נכון את כללי שעון הקיץ, שיכולים להשתנות משנה לשנה וממדינה למדינה.
- **עמימות בזמן פרסום רווחים:** חברה עשויה לדווח על רווחים ב"10 במאי". אבל האם זה היה לפני פתיחת השוק, לאחר סגירתו, או במהלך שעות המסחר? חותמת הזמן המדויקת היא חיונית, ולעתים קרו
- **התעלמות מעלות הנתונים:** נתונים איכותיים, point-in-time, הם יקרים. אבל העלות של קבלת החלטות גרועות על סמך נתונים פגומים גבוהה בהרבה.

## נקודות עיקריות

- היגיינת נתונים היא הבסיס לכל מחקר כמותי.
- הטיית שרידות והטיית צפייה לעתיד הן שתי השגיאות המסוכנות ביותר בבדיקה לאחור.
- השתמש תמיד בנתוני point-in-time.
- נתיב ביקורת מפורט הוא ההגנה הטובה ביותר שלכם מפני שגיאות נתונים.
